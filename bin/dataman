#!/usr/bin/env python
#
import sys

from terminaltables import SingleTable
from terminaltables import AsciiTable
from sh import docker

SERVICES_LIST = [ "redis", "rmq", "mysql", "influxdb", "elasticsearch",
                  "logstash", "harbor", "registry", "drone", "cluster",
                  "app", "metrics", "logging", "billing", "alert", "glance"]


CLUSTER_STATUS = "RUNNING"

def list_services():

    service_status = [
        ["SERVICE", "ID","ENTRYPOINT",  "COMMAND", "IPADDR", "PORTS", "STATUS"],
    ]

    for SERVICE in SERVICES_LIST:
        ID = docker.inspect("--format={{.Id}}", SERVICE).strip()[:12]
        STATUS = docker.inspect("--format={{.State.Status}}", SERVICE).strip()
        ENTRYPOINT = docker.inspect("--format={{range $ep := .Config.Entrypoint}}{{$ep}}{{end}}", SERVICE).strip().strip("{[").strip("]}")
        COMMAND = docker.inspect("--format={{range $cmd := .Config.Cmd}}{{ $cmd }}{{ end }}", SERVICE).strip()
        # PORTS = docker.inspect("--format='{{range $p, $conf := .Config.ExposedPorts}} {{$p}} {{end}}'", SERVICE).strip()
        IPADDR = docker.inspect("--format='{{ .NetworkSettings.IPAddress }}'", SERVICE).strip()  
        PORTS = ""
        item = [SERVICE, ID, ENTRYPOINT, COMMAND, IPADDR, PORTS, STATUS] 
        service_status.append(item)

    return service_status

if __name__ == '__main__':
    if len(sys.argv) > 1:
        if sys.argv[1] == "list":
            table = SingleTable(list_services())
            table.inner_heading_row_border = False
            table.inner_row_border = True
            table.padding_right = 2
            sys.stdout.write("{}\n".format(table.table))
        elif sys.argv[1] == "status":
            sys.stdout.write("{}\n".format(CLUSTER_STATUS))
    else:
        sys.stdout.write("usage: dataman [ status | list ]\n")


